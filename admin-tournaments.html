<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Management - Admin</title>
    <link rel="stylesheet" href="css/admin.css">
    <style>
        .tournament-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .tournament-card {
            background: #1e1e2e;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2a2a40;
        }

        .tournament-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .tournament-title {
            font-size: 18px;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }

        .tournament-game {
            font-size: 13px;
            color: #888;
            text-transform: uppercase;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-badge.registration_open {
            background: #4caf50;
            color: white;
        }

        .status-badge.ongoing {
            background: #ff9800;
            color: white;
        }

        .status-badge.completed {
            background: #9c27b0;
            color: white;
        }

        .status-badge.cancelled {
            background: #f44336;
            color: white;
        }

        .tournament-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .stat-box {
            background: #0a0a15;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: white;
        }

        .tournament-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #2a2a40;
        }

        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-view {
            background: #667eea;
            color: white;
        }

        .btn-edit {
            background: #2196f3;
            color: white;
        }

        .btn-results {
            background: #4caf50;
            color: white;
        }

        .btn-cancel {
            background: #f44336;
            color: white;
        }

        .btn-delete {
            background: #9e9e9e;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background: #1e1e2e;
            border-radius: 16px;
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
        }

        .modal-header {
            font-size: 24px;
            font-weight: 700;
            color: white;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: span 2;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            background: #0a0a15;
            border: 1px solid #2a2a40;
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .prizes-section {
            background: #0a0a15;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .prize-row {
            display: grid;
            grid-template-columns: 100px 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .add-prize-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }

        .remove-prize-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #2a2a40;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #2a2a40;
            color: white;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 10px 15px;
            background: #1e1e2e;
            border: 1px solid #2a2a40;
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }

        .participants-modal {
            max-height: 70vh;
            overflow-y: auto;
        }

        .participant-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .participant-table th,
        .participant-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #2a2a40;
        }

        .participant-table th {
            background: #0a0a15;
            color: #888;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .participant-table td {
            color: white;
            font-size: 14px;
        }

        .results-form {
            max-height: 60vh;
            overflow-y: auto;
        }

        .result-row {
            display: grid;
            grid-template-columns: 50px 2fr 100px 150px;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: #0a0a15;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-group.full-width {
                grid-column: span 1;
            }

            .tournament-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>Tournament Management</h1>
            <div class="header-actions">
                <button class="btn-primary" onclick="openCreateModal()">+ Create Tournament</button>
                <a href="admin-dashboard.html" class="btn-secondary">Back to Dashboard</a>
            </div>
        </div>

        <div class="filters">
            <select class="filter-select" id="status-filter" onchange="loadTournaments()">
                <option value="">All Status</option>
                <option value="registration_open">Registration Open</option>
                <option value="registration_closed">Registration Closed</option>
                <option value="ongoing">Ongoing</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
            </select>

            <select class="filter-select" id="game-filter" onchange="loadTournaments()">
                <option value="">All Games</option>
                <option value="freefire">Free Fire</option>
                <option value="pubg">PUBG</option>
                <option value="bgmi">BGMI</option>
                <option value="cod">Call of Duty</option>
                <option value="valorant">Valorant</option>
                <option value="other">Other</option>
            </select>
        </div>

        <div id="tournaments-container" class="tournament-grid">
            <div class="loading">Loading tournaments...</div>
        </div>
    </div>

    <!-- Create/Edit Tournament Modal -->
    <div id="tournament-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modal-title">Create Tournament</div>
            <form id="tournament-form">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label class="form-label">Tournament Title</label>
                        <input type="text" class="form-input" id="title" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Game</label>
                        <select class="form-select" id="game" required>
                            <option value="freefire">Free Fire</option>
                            <option value="pubg">PUBG</option>
                            <option value="bgmi">BGMI</option>
                            <option value="cod">Call of Duty</option>
                            <option value="valorant">Valorant</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="type" required>
                            <option value="solo">Solo</option>
                            <option value="duo">Duo</option>
                            <option value="squad">Squad</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Total Slots</label>
                        <input type="number" class="form-input" id="totalSlots" required min="2" max="1000">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Entry Fee (₹)</label>
                        <input type="number" class="form-input" id="entryFee" required min="0" step="0.01">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Prize Pool (₹)</label>
                        <input type="number" class="form-input" id="prizePool" required min="0" step="0.01">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Platform</label>
                        <select class="form-select" id="platform">
                            <option value="all">All</option>
                            <option value="android">Android</option>
                            <option value="ios">iOS</option>
                            <option value="pc">PC</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Start Time</label>
                        <input type="datetime-local" class="form-input" id="startTime" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">End Time</label>
                        <input type="datetime-local" class="form-input" id="endTime" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Registration Deadline</label>
                        <input type="datetime-local" class="form-input" id="registrationDeadline" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Map</label>
                        <input type="text" class="form-input" id="map" placeholder="e.g., Bermuda, Erangel">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Perspective</label>
                        <select class="form-select" id="perspective">
                            <option value="">Not Set</option>
                            <option value="fpp">FPP</option>
                            <option value="tpp">TPP</option>
                            <option value="both">Both</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Room ID</label>
                        <input type="text" class="form-input" id="roomId">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Room Password</label>
                        <input type="text" class="form-input" id="roomPassword">
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="description" required></textarea>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">Rules</label>
                        <textarea class="form-textarea" id="rules"></textarea>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">Prize Distribution</label>
                        <div class="prizes-section" id="prizes-container">
                            <!-- Prizes will be added here -->
                        </div>
                        <button type="button" class="add-prize-btn" onclick="addPrizeRow()">+ Add Prize</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="featured"> Featured Tournament
                        </label>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="modal-btn btn-secondary" onclick="closeTournamentModal()">
                        Cancel
                    </button>
                    <button type="submit" class="modal-btn btn-primary">
                        Save Tournament
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Participants Modal -->
    <div id="participants-modal" class="modal">
        <div class="modal-content participants-modal">
            <div class="modal-header">Tournament Participants</div>
            <div id="participants-content"></div>
            <div class="modal-buttons">
                <button type="button" class="modal-btn btn-secondary" onclick="closeParticipantsModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Publish Results Modal -->
    <div id="results-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Publish Results</div>
            <div class="results-form" id="results-content"></div>
            <div class="modal-buttons">
                <button type="button" class="modal-btn btn-secondary" onclick="closeResultsModal()">
                    Cancel
                </button>
                <button type="button" class="modal-btn btn-primary" onclick="publishResults()">
                    Publish & Distribute Prizes
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000';
        let currentTournament = null;
        let tournaments = [];
        let prizeCounter = 0;
        let resultsData = [];

        async function loadTournaments() {
            try {
                const token = localStorage.getItem('adminToken');
                const statusFilter = document.getElementById('status-filter').value;
                const gameFilter = document.getElementById('game-filter').value;

                const params = new URLSearchParams();
                if (statusFilter) params.append('status', statusFilter);
                if (gameFilter) params.append('game', gameFilter);

                const response = await fetch(`${API_URL}/admin/tournaments?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load tournaments');
                }

                tournaments = data.tournaments;
                displayTournaments(tournaments);
            } catch (err) {
                console.error('Error loading tournaments:', err);
                document.getElementById('tournaments-container').innerHTML = `
                    <div style="grid-column: span 2; text-align: center; color: #f44336;">
                        ${err.message}
                    </div>
                `;
            }
        }

        function displayTournaments(tournaments) {
            const container = document.getElementById('tournaments-container');

            if (tournaments.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: span 2; text-align: center; padding: 40px; color: #888;">
                        No tournaments found
                    </div>
                `;
                return;
            }

            container.innerHTML = tournaments.map(t => `
                <div class="tournament-card">
                    <div class="tournament-header">
                        <div>
                            <div class="tournament-title">${t.title}</div>
                            <div class="tournament-game">${t.game} • ${t.type}</div>
                        </div>
                        <div class="status-badge ${t.status}">${t.status.replace('_', ' ')}</div>
                    </div>

                    <div class="tournament-stats">
                        <div class="stat-box">
                            <div class="stat-label">Participants</div>
                            <div class="stat-value">${t.currentParticipants}/${t.totalSlots}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Entry Fee</div>
                            <div class="stat-value">₹${t.entryFee}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Prize Pool</div>
                            <div class="stat-value">₹${t.prizePool}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Revenue</div>
                            <div class="stat-value">₹${t.totalRevenue}</div>
                        </div>
                    </div>

                    <div style="font-size: 13px; color: #888; margin-top: 10px;">
                        Start: ${new Date(t.startTime).toLocaleString('en-IN')}
                    </div>

                    <div class="tournament-actions">
                        <button class="action-btn btn-view" onclick="viewParticipants('${t._id}')">
                            Participants
                        </button>
                        <button class="action-btn btn-edit" onclick="editTournament('${t._id}')">
                            Edit
                        </button>
                        ${t.status === 'ongoing' || t.status === 'registration_closed' ? `
                        <button class="action-btn btn-results" onclick="openResultsModal('${t._id}')">
                            Results
                        </button>
                        ` : ''}
                        ${t.status !== 'completed' ? `
                        <button class="action-btn btn-cancel" onclick="cancelTournament('${t._id}')">
                            Cancel
                        </button>
                        ` : ''}
                        <button class="action-btn btn-delete" onclick="deleteTournament('${t._id}')">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function openCreateModal() {
            currentTournament = null;
            document.getElementById('modal-title').textContent = 'Create Tournament';
            document.getElementById('tournament-form').reset();
            document.getElementById('prizes-container').innerHTML = '';
            prizeCounter = 0;
            addPrizeRow();
            addPrizeRow();
            addPrizeRow();
            document.getElementById('tournament-modal').classList.add('active');
        }

        function closeTournamentModal() {
            document.getElementById('tournament-modal').classList.remove('active');
        }

        function addPrizeRow() {
            prizeCounter++;
            const container = document.getElementById('prizes-container');
            const row = document.createElement('div');
            row.className = 'prize-row';
            row.innerHTML = `
                <input type="number" class="form-input" placeholder="Position" min="1" value="${prizeCounter}">
                <input type="number" class="form-input" placeholder="Amount (₹)" min="0" step="0.01">
                <button type="button" class="remove-prize-btn" onclick="this.parentElement.remove()">×</button>
            `;
            container.appendChild(row);
        }

        async function editTournament(id) {
            const tournament = tournaments.find(t => t._id === id);
            if (!tournament) return;

            currentTournament = tournament;
            document.getElementById('modal-title').textContent = 'Edit Tournament';

            // Fill form
            document.getElementById('title').value = tournament.title;
            document.getElementById('game').value = tournament.game;
            document.getElementById('type').value = tournament.type;
            document.getElementById('totalSlots').value = tournament.totalSlots;
            document.getElementById('entryFee').value = tournament.entryFee;
            document.getElementById('prizePool').value = tournament.prizePool;
            document.getElementById('platform').value = tournament.platform || 'all';
            document.getElementById('startTime').value = new Date(tournament.startTime).toISOString().slice(0, 16);
            document.getElementById('endTime').value = new Date(tournament.endTime).toISOString().slice(0, 16);
            document.getElementById('registrationDeadline').value = new Date(tournament.registrationDeadline).toISOString().slice(0, 16);
            document.getElementById('map').value = tournament.map || '';
            document.getElementById('perspective').value = tournament.perspective || '';
            document.getElementById('roomId').value = tournament.roomId || '';
            document.getElementById('roomPassword').value = tournament.roomPassword || '';
            document.getElementById('description').value = tournament.description;
            document.getElementById('rules').value = tournament.rules || '';
            document.getElementById('featured').checked = tournament.featured;

            // Fill prizes
            document.getElementById('prizes-container').innerHTML = '';
            prizeCounter = 0;
            if (tournament.prizes && tournament.prizes.length > 0) {
                tournament.prizes.forEach(prize => {
                    const container = document.getElementById('prizes-container');
                    const row = document.createElement('div');
                    row.className = 'prize-row';
                    row.innerHTML = `
                        <input type="number" class="form-input" placeholder="Position" min="1" value="${prize.position}">
                        <input type="number" class="form-input" placeholder="Amount (₹)" min="0" step="0.01" value="${prize.amount}">
                        <button type="button" class="remove-prize-btn" onclick="this.parentElement.remove()">×</button>
                    `;
                    container.appendChild(row);
                    prizeCounter++;
                });
            } else {
                addPrizeRow();
            }

            document.getElementById('tournament-modal').classList.add('active');
        }

        document.getElementById('tournament-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const prizes = [];
            document.querySelectorAll('.prize-row').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value && inputs[1].value) {
                    prizes.push({
                        position: parseInt(inputs[0].value),
                        amount: parseFloat(inputs[1].value)
                    });
                }
            });

            const data = {
                title: document.getElementById('title').value,
                game: document.getElementById('game').value,
                type: document.getElementById('type').value,
                totalSlots: parseInt(document.getElementById('totalSlots').value),
                entryFee: parseFloat(document.getElementById('entryFee').value),
                prizePool: parseFloat(document.getElementById('prizePool').value),
                platform: document.getElementById('platform').value,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                registrationDeadline: document.getElementById('registrationDeadline').value,
                map: document.getElementById('map').value || null,
                perspective: document.getElementById('perspective').value || null,
                roomId: document.getElementById('roomId').value || null,
                roomPassword: document.getElementById('roomPassword').value || null,
                description: document.getElementById('description').value,
                rules: document.getElementById('rules').value || null,
                featured: document.getElementById('featured').checked,
                prizes
            };

            try {
                const token = localStorage.getItem('adminToken');
                const url = currentTournament 
                    ? `${API_URL}/admin/tournaments/${currentTournament._id}`
                    : `${API_URL}/admin/tournaments`;
                const method = currentTournament ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to save tournament');
                }

                alert('✅ Tournament saved successfully!');
                closeTournamentModal();
                loadTournaments();
            } catch (err) {
                console.error('Error saving tournament:', err);
                alert('❌ ' + err.message);
            }
        });

        async function deleteTournament(id) {
            if (!confirm('Are you sure you want to delete this tournament?')) return;

            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`${API_URL}/admin/tournaments/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to delete tournament');
                }

                alert('✅ Tournament deleted successfully!');
                loadTournaments();
            } catch (err) {
                console.error('Error deleting tournament:', err);
                alert('❌ ' + err.message);
            }
        }

        async function cancelTournament(id) {
            const reason = prompt('Enter cancellation reason:');
            if (!reason) return;

            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`${API_URL}/admin/tournaments/${id}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ reason })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to cancel tournament');
                }

                alert(`✅ ${data.message}`);
                loadTournaments();
            } catch (err) {
                console.error('Error cancelling tournament:', err);
                alert('❌ ' + err.message);
            }
        }

        async function viewParticipants(id) {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`${API_URL}/admin/tournaments/${id}/participants`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load participants');
                }

                const html = `
                    <table class="participant-table">
                        <thead>
                            <tr>
                                <th>Slot</th>
                                <th>Team Name</th>
                                <th>IGN</th>
                                <th>ID</th>
                                <th>Status</th>
                                <th>Entry Fee</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.participants.map(p => `
                                <tr>
                                    <td>#${p.slotNumber}</td>
                                    <td>${p.teamName}</td>
                                    <td>${p.inGameName}</td>
                                    <td>${p.inGameId}</td>
                                    <td>${p.status}</td>
                                    <td>₹${p.entryFeePaid}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                document.getElementById('participants-content').innerHTML = html;
                document.getElementById('participants-modal').classList.add('active');
            } catch (err) {
                console.error('Error loading participants:', err);
                alert('❌ ' + err.message);
            }
        }

        function closeParticipantsModal() {
            document.getElementById('participants-modal').classList.remove('active');
        }

        async function openResultsModal(id) {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`${API_URL}/admin/tournaments/${id}/participants`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load participants');
                }

                const tournament = tournaments.find(t => t._id === id);
                currentTournament = tournament;
                resultsData = [];

                const html = data.participants.map((p, index) => {
                    resultsData.push({ participantId: p._id, position: index + 1, prize: 0 });
                    return `
                        <div class="result-row">
                            <div>#${index + 1}</div>
                            <div>${p.teamName} (${p.inGameName})</div>
                            <input type="number" class="form-input" placeholder="Position" value="${index + 1}" 
                                   onchange="updatePosition(${index}, this.value)">
                            <input type="number" class="form-input" placeholder="Prize (₹)" step="0.01" 
                                   onchange="updatePrize(${index}, this.value)">
                        </div>
                    `;
                }).join('');

                document.getElementById('results-content').innerHTML = html;
                document.getElementById('results-modal').classList.add('active');
            } catch (err) {
                console.error('Error opening results modal:', err);
                alert('❌ ' + err.message);
            }
        }

        function updatePosition(index, position) {
            resultsData[index].position = parseInt(position);
        }

        function updatePrize(index, prize) {
            resultsData[index].prize = parseFloat(prize);
        }

        function closeResultsModal() {
            document.getElementById('results-modal').classList.remove('active');
        }

        async function publishResults() {
            if (!confirm('Publish results and distribute prizes to winners?')) return;

            const winners = resultsData.filter(r => r.prize > 0);

            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`${API_URL}/admin/tournaments/${currentTournament._id}/publish-results`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ winners })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to publish results');
                }

                alert('✅ Results published and prizes distributed!');
                closeResultsModal();
                loadTournaments();
            } catch (err) {
                console.error('Error publishing results:', err);
                alert('❌ ' + err.message);
            }
        }

        // Initial load
        loadTournaments();
    </script>
</body>
</html>
