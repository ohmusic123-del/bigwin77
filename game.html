<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>BIGWIN Game</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

<header class="top-header">
  <button class="back-btn" onclick="location.href='home.html'">‚Üê</button>
  <h1>BIGWIN</h1>
  <div class="balance" id="walletBalance">‚Çπ0</div>
</header>

<section class="card">
  <div class="round-info">
    <div>Round: <span id="roundId">---</span></div>
    <div>Time: <span id="timeLeft">--</span>s</div>
  </div>
</section>

<section class="card">
  <h2>Select Color</h2>
  <div class="color-row">
    <button id="redBtn" class="color-btn red">RED</button>
    <button id="greenBtn" class="color-btn green">GREEN</button>
  </div>
</section>

<section class="card hidden" id="betSection">
  <h2>Select Amount</h2>

  <div class="amount-row">
    <button class="amount-btn" data-amount="1">‚Çπ1</button>
    <button class="amount-btn" data-amount="5">‚Çπ5</button>
    <button class="amount-btn" data-amount="10">‚Çπ10</button>
    <button class="amount-btn" data-amount="50">‚Çπ50</button>
  </div>

  <div class="bet-row">
    <button id="plusBtn" class="plus-btn">+</button>
    <div class="bet-display">‚Çπ<span id="betAmount">0</span></div>
  </div>

  <button id="placeBetBtn" class="primary-btn disabled">Place Bet</button>
</section>

<section class="card">
  <div class="tab-header">
    <button id="resultsTab" class="tab active">Results</button>
    <button id="myBetsTab" class="tab">My Bets</button>
  </div>

  <div id="resultsList" class="tab-content"></div>
  <div id="myBetsList" class="tab-content hidden"></div>
</section>

<nav class="bottom-nav">
  <a href="home.html">Home</a>
  <a href="wallet.html">Wallet</a>
  <a href="game.html" class="active">Game</a>
  <a href="profile.html">Profile</a>
</nav>

<!-- ‚úÖ INLINE JAVASCRIPT - NO EXTERNAL FILES -->
<script>
const API = "https://color-game-backend1.onrender.com";

console.log("üöÄ Game.js INLINE starting...");

let selectedColor = null;
let betAmount = 0;

const walletBalance = document.getElementById("walletBalance");
const roundIdEl = document.getElementById("roundId");
const timeLeftEl = document.getElementById("timeLeft");
const redBtn = document.getElementById("redBtn");
const greenBtn = document.getElementById("greenBtn");
const betSection = document.getElementById("betSection");
const betAmountEl = document.getElementById("betAmount");
const placeBetBtn = document.getElementById("placeBetBtn");
const plusBtn = document.getElementById("plusBtn");
const amountBtns = document.querySelectorAll(".amount-btn");
const resultsTab = document.getElementById("resultsTab");
const myBetsTab = document.getElementById("myBetsTab");
const resultsList = document.getElementById("resultsList");
const myBetsList = document.getElementById("myBetsList");

const token = localStorage.getItem("token");

if (!token) {
  alert("Please login first");
  location.href = "index.html";
}

function selectColor(color) {
  selectedColor = color;
  betAmount = 0;
  betAmountEl.textContent = "0";
  betSection.classList.remove("hidden");
  placeBetBtn.classList.add("disabled");
}

redBtn.onclick = () => selectColor("red");
greenBtn.onclick = () => selectColor("green");

amountBtns.forEach(btn => {
  btn.onclick = () => {
    betAmount = Number(btn.dataset.amount);
    betAmountEl.textContent = betAmount;
    placeBetBtn.classList.remove("disabled");
  };
});

plusBtn.onclick = () => {
  if (betAmount > 0) {
    betAmount *= 2;
    betAmountEl.textContent = betAmount;
  }
};

placeBetBtn.onclick = async () => {
  if (!selectedColor || betAmount <= 0) {
    alert("Select color and amount first");
    return;
  }

  try {
    const res = await fetch(API + "/bet", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: token
      },
      body: JSON.stringify({
        color: selectedColor,
        amount: betAmount
      })
    });

    const data = await res.json();

    if (res.ok) {
      alert(data.message);
      loadGame();
      betSection.classList.add("hidden");
      selectedColor = null;
      betAmount = 0;
    } else {
      alert(data.error || "Bet failed");
    }
  } catch (err) {
    console.error("Bet error:", err);
    alert("Network error. Please try again.");
  }
};

async function updateTimer() {
  try {
    const res = await fetch(API + "/round/current");
    const data = await res.json();

    if (data.id) {
      roundIdEl.textContent = data.id.substring(0, 8);
      
      const elapsed = Math.floor((Date.now() - data.startTime) / 1000);
      const remaining = Math.max(0, 30 - elapsed);
      
      timeLeftEl.textContent = remaining;

      if (remaining === 0) {
        setTimeout(() => {
          loadResults();
          loadMyBets();
          loadWallet();
        }, 2000);
      }
    }
  } catch (err) {
    console.error("Timer error:", err);
  }
}

async function loadWallet() {
  try {
    const res = await fetch(API + "/wallet", {
      headers: { Authorization: token }
    });
    
    const data = await res.json();
    
    if (data.wallet !== undefined) {
      walletBalance.textContent = "‚Çπ" + data.wallet;
    }
  } catch (err) {
    console.error("Wallet error:", err);
  }
}

async function loadResults() {
  try {
    const res = await fetch(API + "/rounds/history");
    const data = await res.json();
    
    if (data && data.length > 0) {
      resultsList.innerHTML = data
        .slice(0, 10)
        .map(r => {
          const colorClass = r.winner === 'red' ? 'style="color: #ff4444;"' : 'style="color: #44ff44;"';
          return `<div class="list-item">
            Round ${r.roundId.substring(0, 8)} ‚Üí 
            <span ${colorClass}>${r.winner.toUpperCase()}</span>
          </div>`;
        })
        .join("");
    } else {
      resultsList.innerHTML = "<div class='list-item'>No results yet</div>";
    }
  } catch (err) {
    console.error("Results error:", err);
    resultsList.innerHTML = "<div class='list-item'>Failed to load results</div>";
  }
}

async function loadMyBets() {
  try {
    const res = await fetch(API + "/bets", {
      headers: { Authorization: token }
    });
    
    const data = await res.json();
    
    if (data && data.length > 0) {
      myBetsList.innerHTML = data
        .slice(0, 10)
        .map(b => {
          const statusColor = 
            b.status === 'WON' ? 'style="color: #44ff44;"' :
            b.status === 'LOST' ? 'style="color: #ff4444;"' :
            'style="color: #ffaa00;"';
          
          return `<div class="list-item">
            ${b.color.toUpperCase()} | ‚Çπ${b.amount} | 
            <span ${statusColor}>${b.status}</span>
          </div>`;
        })
        .join("");
    } else {
      myBetsList.innerHTML = "<div class='list-item'>No bets yet</div>";
    }
  } catch (err) {
    console.error("Bets error:", err);
    myBetsList.innerHTML = "<div class='list-item'>Failed to load bets</div>";
  }
}

async function loadGame() {
  loadWallet();
  loadResults();
  loadMyBets();
}

resultsTab.onclick = () => {
  resultsTab.classList.add("active");
  myBetsTab.classList.remove("active");
  resultsList.classList.remove("hidden");
  myBetsList.classList.add("hidden");
};

myBetsTab.onclick = () => {
  myBetsTab.classList.add("active");
  resultsTab.classList.remove("active");
  myBetsList.classList.remove("hidden");
  resultsList.classList.add("hidden");
};

console.log("üéØ Starting game...");
loadGame();
setInterval(updateTimer, 1000);
updateTimer();

console.log("‚úÖ Game initialized!");
</script>
</body>
  </html>
